<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>W3U + M3U Builder · Importar / Exportar</title>
<style>
  :root { color-scheme: dark; }
  body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#0b0f17; color:#e9eef5; }
  header { display:flex; align-items:center; justify-content:space-between; gap:12px; padding:14px 18px; background:#111826; border-bottom:1px solid #233044; position:sticky; top:0; z-index:10; }
  h1 { margin:0; font-size:18px; font-weight:800; }
  main { max-width:1100px; margin:0 auto; padding:18px; }
  .row { display:flex; flex-wrap:wrap; gap:10px; }
  .card { background:#111826; border:1px solid #233044; border-radius:14px; padding:14px; }
  .controls { display:grid; grid-template-columns:1fr auto auto auto auto; gap:10px; align-items:center; }
  .controls input[type="text"]{ width:100%; padding:10px; border-radius:10px; border:1px solid #2b3a52; background:#0f1623; color:#e9eef5; }
  button { padding:10px 14px; border-radius:12px; border:1px solid #2b3a52; background:#1f2b3d; color:#e9eef5; cursor:pointer; }
  button:hover { filter:brightness(1.1); }
  .grid { display:grid; gap:10px; grid-template-columns: repeat( auto-fill, minmax(240px, 1fr) ); }
  .chip { display:inline-flex; gap:8px; align-items:center; padding:6px 10px; border-radius:999px; background:#0f1623; border:1px solid #233044; font-size:12px; }
  .item { background:#0f1623; border:1px solid #233044; border-radius:14px; padding:10px; display:flex; gap:10px; align-items:center; }
  .item img { width:56px; height:56px; object-fit:cover; border-radius:10px; background:#0b0f17; }
  .item .meta { flex:1; min-width:0; }
  .item .meta b { display:block; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .item .meta small { opacity:.8; }
  .pill { font-size:11px; opacity:.85; border:1px solid #233044; border-radius:999px; padding:2px 8px; }
  .player { position:sticky; bottom:0; background:#0b0f17cc; backdrop-filter: blur(8px); border-top:1px solid #233044; padding:10px; }
  video { width:100%; max-height:45vh; background:#000; border-radius:12px; }
  .drop { border:2px dashed #2b3a52; border-radius:14px; padding:16px; text-align:center; opacity:.9; }
  .warn { color:#ffcf7d; }
</style>
</head>
<body>
  <header>
    <h1>📦 W3U + M3U Builder · Importar/Leer/Exportar</h1>
    <div class="chip">Compatible: <span class="pill">.w3u</span><span class="pill">.m3u/.m3u8</span><span class="pill">.json</span></div>
  </header>
  <main>
    <div class="card" id="importer">
      <div class="row" style="gap:12px; align-items:center">
        <div class="drop" id="dropZone">
          Arrastra aquí tu archivo (.w3u / .m3u / .m3u8 / .json)
          <br/><small class="warn">También soporta contenido Base64 y variantes JSON de Wiseplay/WebTV</small>
        </div>
        <input type="file" id="fileInput" accept=".w3u,.m3u,.m3u8,.txt,.json"/>
      </div>
      <div class="controls" style="margin-top:12px">
        <input type="text" id="urlInput" placeholder="Pega URL de lista (.w3u / .m3u8 / .m3u / .json / Base64) y presiona Importar"/>
        <select id="presetSelect" title="Selecciona un listado guardado"></select>
        <button id="btnLoadPreset" title="Cargar preset seleccionado">Cargar preset</button>
        <button id="btnSavePreset" title="Guardar la URL actual como preset">Guardar preset</button>
        <button id="btnImportUrl">Importar URL</button>
        <button id="btnExportM3U">Exportar M3U</button>
        <button id="btnExportJSON">Exportar JSON</button>
        <button id="btnToMiTV">Agregar a Mi TV Station</button>
      </div>
      <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap">
        <span class="chip" id="countChip">0 canales</span>
        <span class="chip" id="groupsChip">Grupos: 0</span>
        <span class="chip" id="errorsChip">Errores: 0</span>
      </div>
    </div>

    <div class="card" style="margin-top:14px">
      <div class="grid" id="list"></div>
    </div>

    <div class="player">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px">
        <div class="chip">🔊 Tester de reproducción (HLS)</div>
        <small id="nowPlaying"></small>
      </div>
      <video id="video" controls playsinline></video>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.8/dist/hls.min.js"></script>
  <script>
  let CHANNELS = [];
  let ERRORS = 0;

  // ==============================
  // 📚 Presets (selector de listados)
  // ==============================
  const DEFAULT_PRESETS = [
    { name: "nuevo SamsungTVPlus_tv_US.w3u", url: "https://helmerluzo.github.io/SamsungTVPlus_HL/tv/w3u/SamsungTVPlus_tv_US.w3u" },
    { name: "nuevo2 SamsungTVPlus_tv_FR.w3u", url: "https://helmerluzo.github.io/SamsungTVPlus_HL/tv/w3u/SamsungTVPlus_tv_FR.w3u" },
    { name: "nuevo 5 SamsungTVPlus_tv_CH.w3u", url: "https://helmerluzo.github.io/SamsungTVPlus_HL/tv/w3u/SamsungTVPlus_tv_CH.w3u" },
    { name: "nuevo 6 SamsungTVPlus_tv_GB.w3u", url: "https://helmerluzo.github.io/SamsungTVPlus_HL/tv/w3u/SamsungTVPlus_tv_GB.w3u" },
    { name: "nuevo 7 SamsungTVPlus_tv_IT.w3u", url: "https://helmerluzo.github.io/SamsungTVPlus_HL/tv/w3u/SamsungTVPlus_tv_IT.w3u" },
    { name: "nuevo 8 SamsungTVPlus_tv_IN.w3u", url: "https://helmerluzo.github.io/SamsungTVPlus_HL/tv/w3u/SamsungTVPlus_tv_IN.w3u" },
    { name: "nuevo 8 SamsungTVPlus_tv_FR.w3u", url: "https://helmerluzo.github.io/SamsungTVPlus_HL/tv/w3u/SamsungTVPlus_tv_FR.w3u" },
    { name: "nuevo 9 SamsungTVPlus_tv_KR.w3u", url: "https://helmerluzo.github.io/SamsungTVPlus_HL/tv/w3u/SamsungTVPlus_tv_KR.w3u" },
    { name: "nuevo 10 SamsungTVPlus_tv_CA.w3u", url: "https://helmerluzo.github.io/SamsungTVPlus_HL/tv/w3u/SamsungTVPlus_tv_CA.w3u" },
    { name: "nuevo 11 SamsungTVPlus_tv_AT.w3u", url: "https://helmerluzo.github.io/SamsungTVPlus_HL/tv/w3u/SamsungTVPlus_tv_AT.w3u" },
    { name: "nuevo 12 SamsungTVPlus_tv_DE.w3u", url: "https://helmerluzo.github.io/SamsungTVPlus_HL/tv/w3u/SamsungTVPlus_tv_DE.w3u" },
    { name: "nuevo 13 SamsungTVPlus_tv_ES.w3u", url: "https://helmerluzo.github.io/SamsungTVPlus_HL/tv/w3u/SamsungTVPlus_tv_ES.w3u" }
  ];
  const PRESETS_KEY = 'w3u_m3u_presets_v1';

  function loadUserPresets(){
    try { return JSON.parse(localStorage.getItem(PRESETS_KEY)||'[]'); } catch { return []; }
  }
  function saveUserPresets(list){
    localStorage.setItem(PRESETS_KEY, JSON.stringify(list||[]));
  }
  function getAllPresets(){
    const user = loadUserPresets();
    const map = new Map();
    [...DEFAULT_PRESETS, ...user].forEach(p=>{ if (p && p.url) map.set(p.url, p); });
    return Array.from(map.values());
  }
  function renderPresets(){
    const sel = document.getElementById('presetSelect');
    if (!sel) return;
    sel.innerHTML = '';
    const all = getAllPresets();
    const opt0 = document.createElement('option');
    opt0.value = ''; opt0.textContent = '— Selecciona un preset —';
    sel.appendChild(opt0);
    for (const p of all){
      const o = document.createElement('option');
      o.value = p.url; o.textContent = p.name || p.url;
      sel.appendChild(o);
    }
  }

  const isProbablyBase64 = (s='') => {
    try {
      if (!s) return false;
      if (s.startsWith('data:') || s.startsWith('base64,')) return true;
      const t = s.trim().replace(/^data:[^,]*,/, '').replace(/^base64,/, '');
      return /^[A-Za-z0-9+/=\r\n]+$/.test(t) && t.replace(/\s+/g,'').length >= 24;
    } catch { return false; }
  };

  const b64decode = (s='') => {
    try {
      const clean = s.trim().replace(/^data:[^,]*,/, '').replace(/^base64,/, '');
      return atob(clean);
    } catch(e){ return s; }
  };

  const safeJSON = (txt) => { try { return JSON.parse(txt); } catch { return null; } };

  const textFromResponse = async (res) => {
    const ct = res.headers.get('content-type') || '';
    if (ct.includes('application/json')) return await res.text();
    return await res.text();
  };

  const downloadFile = (filename, text) => {
    const blob = new Blob([text], {type: 'text/plain;charset=utf-8'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
  };

  function parseM3U(m3uText){
    const lines = (m3uText || '').split(/\r?\n/);
    const out = [];
    let current = null;
    for (let raw of lines){
      const line = (raw || '').trim();
      if (!line) continue;
      if (line.startsWith('#EXTINF')){
        const attrs = {};
        const attrRe = /(\w[\w-]*)="(.*?)"/g; let m;
        while((m = attrRe.exec(line))){ attrs[m[1]] = m[2]; }
        const comma = line.indexOf(',');
        const name = comma >= 0 ? line.slice(comma+1).trim() : 'Canal';
        current = { name, logo: attrs['tvg-logo'] || '', group: attrs['group-title'] || '', url: '', headers: '' };
      } else if (line.startsWith('#')){
        continue;
      } else {
        if (!current){ current = { name: line.split('/').pop() || 'Canal', logo:'', group:'', url:'', headers:''}; }
        current.url = line.trim();
        out.push(current); current = null;
      }
    }
    return out;
  }

  function parseW3UJson(obj){
    const out = [];
    if (!obj) return out;

    if (Array.isArray(obj.channels)){
      for (const ch of obj.channels){
        if (!ch) continue;
        const urls = Array.isArray(ch.url) ? ch.url : [ch.url];
        for (const u of urls){ if (!u) continue; out.push({ name: ch.name || 'Canal', url: u, logo: ch.logo || '', group: ch.group || ch.category || '', headers: ch.headers || '' }); }
      }
      return out;
    }

    if (Array.isArray(obj.streams)){
      for (const it of obj.streams){
        if (!it) continue;
        const urls = Array.isArray(it.url) ? it.url : [it.url];
        for (const u of urls){ if (!u) continue; out.push({ name: it.title || it.name || 'Canal', url: u, logo: it.image || it.logo || '', group: it.category || it.group || '', headers: it.headers || '' }); }
      }
      return out;
    }

    if (Array.isArray(obj)){
      for (const it of obj){ if (it && it.url){ out.push({ name: it.name || 'Canal', url: it.url, logo: it.logo || '', group: it.group || it.category || '', headers: it.headers || '' }); } }
      return out;
    }

    if (Array.isArray(obj.groups)){
      for (const grp of obj.groups){
        if (!Array.isArray(grp.stations)) continue;
        for (const st of grp.stations){
          const urls = Array.isArray(st.url) ? st.url : [st.url];
          for (const u of urls){ if (!u) continue; out.push({ name: st.name || 'Canal', url: u, logo: st.image || st.logo || '', group: st.category || st.group || grp.name || '', headers: st.headers || '' }); }
        }
      }
      return out;
    }

    return out;
  }

  function parseW3U(anyText){
    let txt = anyText || '';
    if (/^#EXTM3U/i.test(txt) || /#EXTINF/i.test(txt)){
      return parseM3U(txt);
    }
    if (isProbablyBase64(txt)){
      const decoded = b64decode(txt);
      if (decoded){
        if (/^#EXTM3U/i.test(decoded) || /#EXTINF/i.test(decoded)) return parseM3U(decoded);
        const j = safeJSON(decoded);
        if (j) return parseW3UJson(j);
      }
    }
    const asJSON = safeJSON(txt);
    if (asJSON){ return parseW3UJson(asJSON); }
    return parseM3U(txt);
  }

  function normalizeChannels(chs){
    const out = [];
    for (const c of (chs||[])){
      if (!c || !c.url) continue;
      out.push({ name: (c.name||'Canal').toString(), url: c.url.toString(), logo: (c.logo||'').toString(), group: (c.group||'').toString(), headers: (c.headers||'').toString() });
    }
    return out;
  }

  function toM3U(chs){
    const lines = ['#EXTM3U'];
    for (const c of chs){
      const attrs = [];
      if (c.logo) attrs.push(`tvg-logo="${c.logo.replace(/"/g,'\\"')}"`);
      if (c.group) attrs.push(`group-title="${c.group.replace(/"/g,'\\"')}"`);
      const meta = `#EXTINF:-1 ${attrs.join(' ')} , ${c.name}`.replace(/ +,/g, ' ,');
      lines.push(meta);
      lines.push(c.url);
    }
    return lines.join('\n');
  }

  function toJSON(chs){
    const obj = { name: "Export W3U/M3U Builder", channels: chs };
    return JSON.stringify(obj, null, 2);
  }

  function render(){
    const list = document.querySelector('#list');
    list.innerHTML = '';
    const groups = new Set();
    CHANNELS.forEach(c=>{ if (c.group) groups.add(c.group); });
    document.querySelector('#countChip').textContent = `${CHANNELS.length} canales`;
    document.querySelector('#groupsChip').textContent = `Grupos: ${groups.size}`;
    document.querySelector('#errorsChip').textContent = `Errores: ${ERRORS}`;
    for (const c of CHANNELS){
      const el = document.createElement('div');
      el.className = 'item';
      el.innerHTML = `
        <img src="${c.logo || ''}" onerror="this.src='';" alt="logo"/>
        <div class="meta">
          <b title="${c.name}">${c.name}</b>
          <small>${c.group || 'Sin grupo'}</small>
        </div>
        <button class="play">▶️ Probar</button>
      `;
      el.querySelector('.play').addEventListener('click',()=> play(c));
      list.appendChild(el);
    }
  }

  function setNowPlaying(txt){ document.querySelector('#nowPlaying').textContent = txt || ''; }

  function play(ch){
    const video = document.querySelector('#video');
    setNowPlaying(`${ch.name} · ${ch.url}`);
    try{
      if (Hls.isSupported() && /\.m3u8(\?|$)/i.test(ch.url)){
        if (window.__hls){ window.__hls.destroy(); }
        const hls = new Hls();
        hls.loadSource(ch.url);
        hls.attachMedia(video);
        window.__hls = hls;
      } else {
        if (window.__hls){ window.__hls.destroy(); window.__hls = null; }
        video.src = ch.url;
      }
      video.play().catch(()=>{});
    }catch(e){ console.error(e); ERRORS++; render(); }
  }

  async function handleTextImport(txt){
    try{
      let parsed = parseW3U(txt);
      parsed = normalizeChannels(parsed);
      CHANNELS = parsed;
      render();
    } catch(e){ console.error('Import error', e); ERRORS++; render(); }
  }

  document.querySelector('#fileInput').addEventListener('change', async (ev)=>{
    const f = ev.target.files[0]; if (!f) return;
    const text = await f.text();
    handleTextImport(text);
  });

  const dropZone = document.querySelector('#dropZone');
  dropZone.addEventListener('dragover', (e)=>{ e.preventDefault(); dropZone.style.filter = 'brightness(1.2)'; });
  dropZone.addEventListener('dragleave', ()=>{ dropZone.style.filter = ''; });
  dropZone.addEventListener('drop', async (e)=>{
    e.preventDefault(); dropZone.style.filter = '';
    const f = e.dataTransfer.files && e.dataTransfer.files[0];
    if (f){ const text = await f.text(); handleTextImport(text); }
  });

  document.querySelector('#btnImportUrl').addEventListener('click', async ()=>{
    const url = document.querySelector('#urlInput').value.trim();
    if (!url) return;
    try{
      if (isProbablyBase64(url)){
        const decoded = b64decode(url);
        await handleTextImport(decoded);
        return;
      }
      const res = await fetch(url, { mode: 'cors' });
      const txt = await textFromResponse(res);
      await handleTextImport(txt);
    } catch(e){ console.error('Fetch error', e); ERRORS++; render(); }
  });

  // Presets: cargar y guardar
  document.getElementById('btnLoadPreset').addEventListener('click', ()=>{
    const sel = document.getElementById('presetSelect');
    const val = sel.value.trim();
    if (!val) return;
    document.getElementById('urlInput').value = val;
    document.getElementById('btnImportUrl').click();
  });
  document.getElementById('presetSelect').addEventListener('change', ()=>{
    const sel = document.getElementById('presetSelect');
    if (!sel.value) return;
    document.getElementById('urlInput').value = sel.value;
    // Auto-cargar al seleccionar
    document.getElementById('btnImportUrl').click();
  });
  document.getElementById('btnSavePreset').addEventListener('click', ()=>{
    const url = document.getElementById('urlInput').value.trim();
    if (!url) return alert('Primero pega una URL válida.');
    const name = prompt('Nombre para guardar este preset:', url);
    if (!name) return;
    const user = loadUserPresets();
    const exists = user.find(p => p.url === url);
    if (exists){ exists.name = name; }
    else { user.push({ name, url }); }
    saveUserPresets(user);
    renderPresets();
    alert('Preset guardado.');
  });

  // 1-click a Mi TV Station (si está disponible)
  document.getElementById('btnToMiTV').addEventListener('click', ()=>{
    if (window.MiTV && typeof window.MiTV.bulkImport === 'function'){
      window.MiTV.bulkImport(CHANNELS);
      alert(`Importados ${CHANNELS.length} canales a Mi TV Station`);
    } else {
      alert('Mi TV Station no está abierto o no expone window.MiTV.bulkImport');
    }
  });

  // Render inicial del selector de presets
  renderPresets();

  document.querySelector('#btnExportM3U').addEventListener('click', ()=>{
  if (!CHANNELS.length) return;
  const m3u = toM3U(CHANNELS);
  downloadFile('export.m3u', m3u);
});

document.querySelector('#btnExportJSON').addEventListener('click', ()=>{
  if (!CHANNELS.length) return;
  const json = toJSON(CHANNELS);
  downloadFile('export.w3u.json', json);
});

// ==============================
// 🔧 Auto-carga si hay #url=...
// ==============================
(async function autoLoadFromHash(){
  const m = location.hash.match(/#url=(.*)$/);
  if (m){
    const u = decodeURIComponent(m[1]);
    document.getElementById('urlInput').value = u;
    document.getElementById('btnImportUrl').click();
  }
})();
  </script>
</body>
</html>
